<div class="container mx-auto p-6">
    <!-- Success/Error Messages -->
    <div *ngIf="successMessage" class="mb-4 p-4 bg-green-100 text-green-700 rounded-lg">
      {{ successMessage }}
    </div>
    <div *ngIf="errorMessage" class="mb-4 p-4 bg-red-100 text-red-700 rounded-lg">
      {{ errorMessage }}
    </div>
  
    <!-- Add Promotion Form -->
    <div class="mb-8 p-6 bg-white shadow-md rounded-lg">
      <h2 class="text-xl font-bold mb-4">Add New Promotion</h2>
      <form #promotionForm="ngForm" (ngSubmit)="addPromotion()" class="space-y-4">
        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-600 mb-1">Offer Name</label>
          <input
            type="text"
            [(ngModel)]="newPromotion.nom"
            name="nom"
            class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            placeholder="Enter offer name"
            required
          />
        </div>
        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-600 mb-1">Discount (%)</label>
          <input
            type="number"
            [(ngModel)]="newPromotion.pourcentageReduction"
            name="pourcentageReduction"
            class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            placeholder="Enter discount percentage"
            min="0"
            max="100"
            required
          />
        </div>
        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-600 mb-1">Start Date</label>
          <input
            type="date"
            [(ngModel)]="newPromotionStartDate"
            name="dateDebut"
            class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            required
          />
        </div>
        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-600 mb-1">End Date</label>
          <input
            type="date"
            [(ngModel)]="newPromotionEndDate"
            name="dateFin"
            class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            required
          />
        </div>
        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-600 mb-1">Condition</label>
          <input
            type="text"
            [(ngModel)]="newPromotion.conditionPromotion"
            name="conditionPromotion"
            class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            placeholder="Enter condition"
            required
          />
        </div>
        <div class="flex items-center">
          <input
            type="checkbox"
            [(ngModel)]="newPromotion.active"
            name="active"
            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
          />
          <label class="ml-2 text-sm font-medium text-gray-600">Active</label>
        </div>
        <div class="flex space-x-4">
          <button
            type="submit"
            class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg"
            [disabled]="!promotionForm.valid"
          >
            Add Promotion
          </button>
          <button
            type="button"
            (click)="resetForm()"
            class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg"
          >
            Reset
          </button>
        </div>
      </form>
    </div>
  
    <!-- Edit Promotion Form -->
    <div *ngIf="editMode && selectedPromotion" class="mb-8 p-6 bg-white shadow-md rounded-lg">
      <h2 class="text-xl font-bold mb-4">Edit Promotion</h2>
      <form #editForm="ngForm" (ngSubmit)="updatePromotion()" class="space-y-4">
        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-600 mb-1">Offer Name</label>
          <input
            type="text"
            [(ngModel)]="selectedPromotion.nom"
            name="nom"
            class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            placeholder="Enter offer name"
            required
          />
        </div>
        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-600 mb-1">Discount (%)</label>
          <input
            type="number"
            [(ngModel)]="selectedPromotion.pourcentageReduction"
            name="pourcentageReduction"
            class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            placeholder="Enter discount percentage"
            min="0"
            max="100"
            required
          />
        </div>
        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-600 mb-1">Start Date</label>
          <input
            type="date"
            [(ngModel)]="selectedPromotionStartDate"
            name="dateDebut"
            class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            required
          />
        </div>
        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-600 mb-1">End Date</label>
          <input
            type="date"
            [(ngModel)]="selectedPromotionEndDate"
            name="dateFin"
            class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            required
          />
        </div>
        <div class="flex flex-col">
          <label class="text-sm font-medium text-gray-600 mb-1">Condition</label>
          <input
            type="text"
            [(ngModel)]="selectedPromotion.conditionPromotion"
            name="conditionPromotion"
            class="p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
            placeholder="Enter condition"
            required
          />
        </div>
        <div class="flex items-center">
          <input
            type="checkbox"
            [(ngModel)]="selectedPromotion.active"
            name="active"
            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
          />
          <label class="ml-2 text-sm font-medium text-gray-600">Active</label>
        </div>
        <div class="flex space-x-4">
          <button
            type="submit"
            class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg"
            [disabled]="!editForm.valid"
          >
            Update Promotion
          </button>
          <button
            type="button"
            (click)="cancelEdit()"
            class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg"
          >
            Cancel
          </button>
        </div>
      </form>
    </div>
  
    <!-- Filters and Bulk Actions -->
    <div class="mb-6 flex flex-wrap items-center justify-between gap-4">
      <div class="flex flex-wrap gap-4">
        <input
          type="text"
          [(ngModel)]="searchTerm"
          (input)="applyFilters()"
          class="p-2 border border-gray-300 rounded-lg"
          placeholder="Search by name"
          [ngModelOptions]="{ standalone: true }"
        />
        <input
          type="text"
          [(ngModel)]="filterCondition"
          (input)="applyFilters()"
          class="p-2 border border-gray-300 rounded-lg"
          placeholder="Filter by condition"
          [ngModelOptions]="{ standalone: true }"
        />
        <input
          type="date"
          [(ngModel)]="filterStartDate"
          (input)="applyFilters()"
          class="p-2 border border-gray-300 rounded-lg"
          [ngModelOptions]="{ standalone: true }"
        />
        <input
          type="date"
          [(ngModel)]="filterEndDate"
          (input)="applyFilters()"
          class="p-2 border border-gray-300 rounded-lg"
          [ngModelOptions]="{ standalone: true }"
        />
        <button
          (click)="clearFilters()"
          class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg"
        >
          Clear Filters
        </button>
      </div>
      <div class="flex gap-4">
        <button
          (click)="getActivePromotions()"
          class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg"
        >
          {{ showingActiveOnly ? 'Show All' : 'Show Active Only' }}
        </button>
        <button
          (click)="bulkActivate()"
          class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg"
          [disabled]="selectedPromotionIds.size === 0"
        >
          Activate Selected
        </button>
        <button
          (click)="bulkDeactivate()"
          class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg"
          [disabled]="selectedPromotionIds.size === 0"
        >
          Deactivate Selected
        </button>
        <button
          (click)="bulkDelete()"
          class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg"
          [disabled]="selectedPromotionIds.size === 0"
        >
          Delete Selected
        </button>
        <button
          (click)="exportPromotionsToCSV()"
          class="bg-purple-500 hover:bg-purple-600 text-white font-semibold py-2 px-4 rounded-lg"
        >
          Export to CSV
        </button>
        <button
          (click)="applyExpirationPromotion()"
          class="bg-orange-500 hover:bg-orange-600 text-white font-semibold py-2 px-4 rounded-lg"
        >
          Apply Expiration
        </button>
      </div>
    </div>
  
    <!-- Promotions Table -->
    <table
      class="w-full text-left border-collapse"
      *ngIf="filteredPromotions.length > 0; else noData"
    >
      <thead>
        <tr class="bg-gray-100">
          <th class="p-3 border-b">
            <input
              type="checkbox"
              (change)="selectAll()"
              [checked]="selectedPromotionIds.size === filteredPromotions.length && filteredPromotions.length > 0"
            />
          </th>
          <th
            class="p-3 border-b cursor-pointer"
            (click)="sortPromotions('id')"
          >
            ID
          </th>
          <th
            class="p-3 border-b cursor-pointer"
            (click)="sortPromotions('nom')"
          >
            Name
          </th>
          <th
            class="p-3 border-b cursor-pointer"
            (click)="sortPromotions('pourcentageReduction')"
          >
            Discount (%)
          </th>
          <th
            class="p-3 border-b cursor-pointer"
            (click)="sortPromotions('dateDebut')"
          >
            Start Date
          </th>
          <th
            class="p-3 border-b cursor-pointer"
            (click)="sortPromotions('dateFin')"
          >
            End Date
          </th>
          <th
            class="p-3 border-b cursor-pointer"
            (click)="sortPromotions('conditionPromotion')"
          >
            Condition
          </th>
          <th
            class="p-3 border-b cursor-pointer"
            (click)="sortPromotions('active')"
          >
            Active
          </th>
          <th class="p-3 border-b">Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let promotion of filteredPromotions"
          class="hover:bg-gray-50"
        >
          <td class="p-3 border-b">
            <input
              type="checkbox"
              [checked]="selectedPromotionIds.has(promotion.id)"
              (change)="toggleSelection(promotion.id)"
            />
          </td>
          <td class="p-3 border-b">{{ promotion.id }}</td>
          <td class="p-3 border-b">{{ promotion.nom }}</td>
          <td class="p-3 border-b">{{ promotion.pourcentageReduction }}%</td>
          <td class="p-3 border-b">
            {{ formatDateForInput(promotion.dateDebut) }}
          </td>
          <td class="p-3 border-b">
            {{ formatDateForInput(promotion.dateFin) }}
          </td>
          <td class="p-3 border-b">{{ promotion.conditionPromotion }}</td>
          <td class="p-3 border-b">
            {{ promotion.active ? 'Yes' : 'No' }}
          </td>
          <td class="p-3 border-b flex flex-col space-y-2">
            <div class="flex space-x-2">
              <button
                (click)="editPromotion(promotion)"
                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-2 rounded-lg shadow-md transition-all duration-300"
              >
                Edit
              </button>
              <button
                (click)="deletePromotion(promotion.id)"
                class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-2 rounded-lg shadow-md transition-all duration-300"
              >
                Delete
              </button>
              <button
                *ngIf="isAISuggested(promotion)"
                (click)="acceptAISuggestion(promotion.id)"
                class="bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-2 rounded-lg shadow-md transition-all duration-300"
              >
                Accept
              </button>
              <button
                *ngIf="isAISuggested(promotion)"
                (click)="rejectAISuggestion(promotion.id)"
                class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-2 rounded-lg shadow-md transition-all duration-300"
              >
                Reject
              </button>
            </div>
            <div class="flex items-center space-x-2">
              <input
                type="number"
                class="w-32 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                [(ngModel)]="promotionAmounts[promotion.id]"
                placeholder="Enter amount"
                min="0"
                [ngModelOptions]="{ standalone: true }"
              />
              <button
                (click)="applyPromotion(promotion.id)"
                class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-1 px-2 rounded-lg shadow-md transition-all duration-300"
                [disabled]="!(promotionAmounts[promotion.id] > 0)"
              >
                Apply
              </button>
            </div>
            <p
              *ngIf="
                appliedMontants[promotion.id] !== null &&
                appliedMontants[promotion.id] !== undefined
              "
              class="text-gray-600 text-sm"
            >
              New Amount: {{ appliedMontants[promotion.id] }}
            </p>
          </td>
        </tr>
      </tbody>
    </table>
    <ng-template #noData>
      <p class="text-center text-gray-500 py-4">No promotions available.</p>
    </ng-template>
  
    <!-- Analytics Chart -->
    <div class="mt-8 p-6 bg-white shadow-md rounded-lg">
      <h3 class="text-lg font-semibold mb-4">Promotion Analytics</h3>
      <canvas
        baseChart
        [datasets]="barChartData"
        [labels]="barChartLabels"
        [options]="barChartOptions"
        [legend]="true"
        [type]="'bar'"
      ></canvas>
      <p class="mt-4 text-gray-600">Total Promotions Applied: {{ totalPromotionsApplied }}</p>
    </div>
  </div>