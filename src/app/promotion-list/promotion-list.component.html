<div class="container mx-auto p-6 space-y-8">
    <!-- Debug Section -->
    <div class="bg-white p-4 rounded-lg shadow-lg">
      <p>Component Loaded: {{ 'Yes' }}</p>
      <p>Promotions Count: {{ filteredPromotions.length }}</p>
      <p *ngIf="filteredPromotions.length === 0">No promotions data loaded. Check API or console for errors.</p>
      <p *ngIf="errorMessage" class="text-red-500">{{ errorMessage }}</p>
    </div>

    <!-- Toast Notifications -->
    <div *ngIf="successMessage" class="fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-2 animate-fade-in">
      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
      </svg>
      <span>{{ successMessage }}</span>
    </div>
    <div *ngIf="errorMessage" class="fixed top-4 right-4 bg-red-500 text-white p-4 rounded-lg shadow-lg flex items-center space-x-2 animate-fade-in">
      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
      </svg>
      <span>{{ errorMessage }}</span>
    </div>

    <!-- Header -->
    <div class="flex justify-between items-center">
      <h1 class="text-4xl font-extrabold text-gray-800 tracking-tight">Promotional Offers Management</h1>
      <button (click)="applyExpirationPromotion()" 
              class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300 flex items-center space-x-2">
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>Apply Expiration Promotion</span>
      </button>
    </div>

    <!-- Analytics Dashboard -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-2xl font-semibold text-gray-700 mb-6">Promotion Analytics</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <p class="text-lg font-medium text-gray-600">Total Promotions Applied: {{ totalPromotionsApplied }}</p>
        </div>
        <div>
          <canvas baseChart 
                  [datasets]="barChartData" 
                  [labels]="barChartLabels" 
                  [options]="barChartOptions" 
                  [legend]="true" 
                  [type]="'bar'"></canvas>
        </div>
      </div>
    </div>

    <!-- Add/Edit Promotion Form -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-2xl font-semibold text-gray-700 mb-6">{{ editMode ? 'Edit Promotional Offer' : 'Add New Promotional Offer' }}</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Form for Adding a New Promotion -->
        <div *ngIf="!editMode">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-1">Offer Name</label>
            <input type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" 
                   [(ngModel)]="newPromotion.nom" placeholder="Enter offer name" required>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-1">Discount Percentage</label>
            <input type="number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" 
                   [(ngModel)]="newPromotion.pourcentageReduction" placeholder="Enter discount %" min="0" max="100" required>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-1">Start Date</label>
            <input type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" 
                   [(ngModel)]="newPromotionStartDate" required>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-1">End Date</label>
            <input type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" 
                   [(ngModel)]="newPromotionEndDate" required>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-1">Condition</label>
            <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                    [(ngModel)]="newPromotion.conditionPromotion" required>
              <option value="ACHAT_GROUPE">Achat Groupe</option>
              <option value="MONTANT_MIN">Montant Minimum</option>
              <option value="EXPIRATION_PRODUIT">Expiration Produit</option>
            </select>
          </div>
          <div class="mb-4 flex items-center">
            <input type="checkbox" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500" 
                   [(ngModel)]="newPromotion.active">
            <label class="ml-2 text-sm font-medium text-gray-600">Active</label>
          </div>
        </div>

        <!-- Form for Editing a Promotion -->
        <div *ngIf="editMode && selectedPromotion">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-1">Offer Name</label>
            <input type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" 
                   [(ngModel)]="selectedPromotion.nom" placeholder="Enter offer name" required>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-1">Discount Percentage</label>
            <input type="number" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" 
                   [(ngModel)]="selectedPromotion.pourcentageReduction" placeholder="Enter discount %" min="0" max="100" required>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-1">Start Date</label>
            <input type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" 
                   [(ngModel)]="selectedPromotionStartDate" required>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-1">End Date</label>
            <input type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200" 
                   [(ngModel)]="selectedPromotionEndDate" required>
          </div>
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-600 mb-1">Condition</label>
            <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                    [(ngModel)]="selectedPromotion.conditionPromotion" required>
              <option value="ACHAT_GROUPE">Achat Groupe</option>
              <option value="MONTANT_MIN">Montant Minimum</option>
              <option value="EXPIRATION_PRODUIT">Expiration Produit</option>
            </select>
          </div>
          <div class="mb-4 flex items-center">
            <input type="checkbox" class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500" 
                   [(ngModel)]="selectedPromotion.active">
            <label class="ml-2 text-sm font-medium text-gray-600">Active</label>
          </div>
        </div>
      </div>
      <div class="mt-6 flex space-x-3">
        <button *ngIf="!editMode" (click)="addPromotion()" 
                class="bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center space-x-2">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
          </svg>
          <span>Add Offer</span>
        </button>
        <button *ngIf="editMode && selectedPromotion" (click)="updatePromotion()" 
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center space-x-2">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
          </svg>
          <span>Update Offer</span>
        </button>
        <button *ngIf="editMode" (click)="cancelEdit()" 
                class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-300 flex items-center space-x-2">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
          <span>Cancel</span>
        </button>
      </div>
    </div>

    <!-- Filter Section -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-2xl font-semibold text-gray-700 mb-4">Filter Promotions</h2>
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">Search by Name</label>
          <input type="text" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                 [(ngModel)]="searchTerm" (ngModelChange)="applyFilters()" placeholder="Enter offer name">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">Filter by Condition</label>
          <select class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                  [(ngModel)]="filterCondition" (ngModelChange)="applyFilters()">
            <option value="">All Conditions</option>
            <option value="ACHAT_GROUPE">Achat Groupe</option>
            <option value="MONTANT_MIN">Montant Minimum</option>
            <option value="EXPIRATION_PRODUIT">Expiration Produit</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">Start Date</label>
          <input type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                 [(ngModel)]="filterStartDate" (ngModelChange)="applyFilters()">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-600 mb-1">End Date</label>
          <input type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                 [(ngModel)]="filterEndDate" (ngModelChange)="applyFilters()">
        </div>
      </div>
      <div class="mt-4">
        <button (click)="clearFilters()" 
                class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition-all duration-300">
          Clear Filters
        </button>
      </div>
    </div>

    <!-- Promotion List -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-2xl font-semibold text-gray-700 mb-6">Promotion List</h2>
      <div class="flex justify-between mb-4">
        <div class="flex space-x-4">
          <button (click)="getActivePromotions()" 
                  class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300"
                  [class.bg-gray-400]="showingActiveOnly" [disabled]="showingActiveOnly">
            Show Active Only
          </button>
          <button (click)="loadPromotions()" 
                  class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300"
                  [class.bg-gray-400]="!showingActiveOnly" [disabled]="!showingActiveOnly">
            Show All
          </button>
        </div>
        <button (click)="exportPromotionsToCSV()" 
                class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300 flex items-center space-x-2">
          <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
          </svg>
          <span>Export to CSV</span>
        </button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full text-left border-collapse" *ngIf="filteredPromotions.length > 0; else noData">
          <thead>
            <tr class="bg-gray-100">
              <th class="p-3 border-b">
                <input type="checkbox" (change)="selectAll()" [checked]="selectedPromotionIds.size === filteredPromotions.length && filteredPromotions.length > 0">
              </th>
              <th class="p-3 border-b cursor-pointer" (click)="sortPromotions('id')">ID</th>
              <th class="p-3 border-b cursor-pointer" (click)="sortPromotions('nom')">Name</th>
              <th class="p-3 border-b cursor-pointer" (click)="sortPromotions('pourcentageReduction')">Discount (%)</th>
              <th class="p-3 border-b cursor-pointer" (click)="sortPromotions('dateDebut')">Start Date</th>
              <th class="p-3 border-b cursor-pointer" (click)="sortPromotions('dateFin')">End Date</th>
              <th class="p-3 border-b cursor-pointer" (click)="sortPromotions('conditionPromotion')">Condition</th>
              <th class="p-3 border-b cursor-pointer" (click)="sortPromotions('active')">Active</th>
              <th class="p-3 border-b">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let promotion of filteredPromotions" class="hover:bg-gray-50">
              <td class="p-3 border-b">
                <input type="checkbox" [checked]="selectedPromotionIds.has(promotion.id)" (change)="toggleSelection(promotion.id)">
              </td>
              <td class="p-3 border-b">{{ promotion.id }}</td>
              <td class="p-3 border-b">{{ promotion.nom }}</td>
              <td class="p-3 border-b">{{ promotion.pourcentageReduction }}%</td>
              <td class="p-3 border-b">{{ promotion.dateDebut | date:'yyyy-MM-dd' }}</td>
              <td class="p-3 border-b">{{ promotion.dateFin | date:'yyyy-MM-dd' }}</td>
              <td class="p-3 border-b">{{ promotion.conditionPromotion }}</td>
              <td class="p-3 border-b">{{ promotion.active ? 'Yes' : 'No' }}</td>
              <td class="p-3 border-b flex flex-col space-y-2">
                <div class="flex space-x-2">
                  <button (click)="editPromotion(promotion)" 
                          class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-1 px-2 rounded-lg shadow-md transition-all duration-300">
                    Edit
                  </button>
                  <button (click)="deletePromotion(promotion.id)" 
                          class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-2 rounded-lg shadow-md transition-all duration-300">
                    Delete
                  </button>
                  <button *ngIf="isAISuggested(promotion)" (click)="acceptAISuggestion(promotion.id)" 
                          class="bg-green-500 hover:bg-green-600 text-white font-semibold py-1 px-2 rounded-lg shadow-md transition-all duration-300">
                    Accept
                  </button>
                  <button *ngIf="isAISuggested(promotion)" (click)="rejectAISuggestion(promotion.id)" 
                          class="bg-red-500 hover:bg-red-600 text-white font-semibold py-1 px-2 rounded-lg shadow-md transition-all duration-300">
                    Reject
                  </button>
                </div>
                <div class="flex items-center space-x-2">
                  <input type="number" class="w-32 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all duration-200"
                         [(ngModel)]="promotionAmounts[promotion.id]" placeholder="Enter amount" min="0">
                  <button (click)="applyPromotion(promotion.id)" 
                          class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-1 px-2 rounded-lg shadow-md transition-all duration-300"
                          [disabled]="!(promotionAmounts[promotion.id] > 0)">
                    Apply
                  </button>
                </div>
                <p *ngIf="appliedMontants[promotion.id] !== null && appliedMontants[promotion.id] !== undefined" 
                   class="text-gray-600 text-sm">
                  New Amount: {{ appliedMontants[promotion.id] }}
                </p>
              </td>
            </tr>
          </tbody>
        </table>
        <ng-template #noData>
          <p class="text-center text-gray-500 p-4">No promotions available. Please add a promotion or check the API connection.</p>
        </ng-template>
      </div>
    </div>

    <!-- Bulk Actions -->
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <h2 class="text-2xl font-semibold text-gray-700 mb-6">Bulk Actions</h2>
      <div class="flex space-x-4">
        <button (click)="selectAll()" 
                class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300">
          Select All
        </button>
        <button (click)="deselectAll()" 
                class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300">
          Deselect All
        </button>
        <button (click)="bulkActivate()" 
                class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300"
                [disabled]="selectedPromotionIds.size === 0">
          Activate Selected
        </button>
        <button (click)="bulkDeactivate()" 
                class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300"
                [disabled]="selectedPromotionIds.size === 0">
          Deactivate Selected
        </button>
        <button (click)="bulkDelete()" 
                class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300"
                [disabled]="selectedPromotionIds.size === 0">
          Delete Selected
        </button>
      </div>
    </div>
</div>