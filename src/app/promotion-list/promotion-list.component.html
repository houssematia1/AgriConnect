<div class="promotion-list-container p-6">
  <h2 class="text-2xl font-bold mb-6 text-center">Liste des Promotions</h2>

  <!-- Success/Error Messages -->
  <div *ngIf="successMessage" class="bg-green-100 text-green-700 p-4 rounded-lg mb-4 text-center">
    {{ successMessage }}
  </div>
  <div *ngIf="errorMessage" class="bg-red-100 text-red-700 p-4 rounded-lg mb-4 text-center">
    {{ errorMessage }}
  </div>

  <!-- Filters and Actions -->
  <div class="flex flex-wrap justify-between mb-4">
    <div class="flex space-x-4">
      <input type="text" [(ngModel)]="searchTerm" (input)="applyFilters()" placeholder="Rechercher par nom..."
             class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
      <input type="text" [(ngModel)]="filterCondition" (input)="applyFilters()" placeholder="Filtrer par condition..."
             class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
      <input type="date" [(ngModel)]="filterStartDate" (change)="applyFilters()" placeholder="Date de début..."
             class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
      <input type="date" [(ngModel)]="filterEndDate" (change)="applyFilters()" placeholder="Date de fin..."
             class="p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500">
      <button (click)="clearFilters()" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
        Effacer Filtres
      </button>
    </div>
    <div class="flex space-x-4">
      <button (click)="getActivePromotions()" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
        Afficher Promotions Actives
      </button>
      <button (click)="loadPromotions()" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600 transition-colors">
        Rafraîchir les Promotions
      </button>
      <button (click)="exportPromotionsToCSV()" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
        Exporter en CSV
      </button>
    </div>
  </div>

  <!-- Bulk Actions -->
  <div class="mb-4 flex space-x-4">
    <button (click)="selectAll()" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
      Tout Sélectionner
    </button>
    <button (click)="deselectAll()" class="bg-gray-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-gray-600 transition-colors">
      Tout Désélectionner
    </button>
    <button (click)="bulkActivate()" [disabled]="selectedPromotionIds.size === 0"
            class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition-colors">
      Activer Sélection
    </button>
    <button (click)="bulkDeactivate()" [disabled]="selectedPromotionIds.size === 0"
            class="bg-yellow-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-yellow-600 transition-colors">
      Désactiver Sélection
    </button>
    <button (click)="bulkDelete()" [disabled]="selectedPromotionIds.size === 0"
            class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
      Supprimer Sélection
    </button>
  </div>

  <!-- Promotions Table -->
  <div class="overflow-x-auto">
    <table class="min-w-full bg-white shadow-md rounded-lg">
      <thead>
        <tr class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
          <th class="py-3 px-6 text-left">
            <input type="checkbox" (change)="selectAll()" [checked]="selectedPromotionIds.size === paginatedPromotions.length && paginatedPromotions.length > 0">
          </th>
          <th class="py-3 px-6 text-left cursor-pointer" (click)="sortPromotions('id')">ID</th>
          <th class="py-3 px-6 text-left cursor-pointer" (click)="sortPromotions('nom')">Nom</th>
          <th class="py-3 px-6 text-left cursor-pointer" (click)="sortPromotions('pourcentageReduction')">Réduction (%)</th>
          <th class="py-3 px-6 text-left cursor-pointer" (click)="sortPromotions('dateDebut')">Date Début</th>
          <th class="py-3 px-6 text-left cursor-pointer" (click)="sortPromotions('dateFin')">Date Fin</th>
          <th class="py-3 px-6 text-left cursor-pointer" (click)="sortPromotions('conditionPromotion')">Condition</th>
          <th class="py-3 px-6 text-left cursor-pointer" (click)="sortPromotions('active')">Active</th>
          <th class="py-3 px-6 text-left">Produits</th>
          <th class="py-3 px-6 text-left">Actions</th>
        </tr>
      </thead>
      <tbody class="text-gray-600 text-sm font-light">
        <tr *ngFor="let promotion of paginatedPromotions" class="border-b border-gray-200 hover:bg-gray-100">
          <td class="py-3 px-6 text-left">
            <input type="checkbox" (change)="toggleSelection(promotion.id)" [checked]="selectedPromotionIds.has(promotion.id)">
          </td>
          <td class="py-3 px-6 text-left">{{ promotion.id }}</td>
          <td class="py-3 px-6 text-left">{{ promotion.nom }}</td>
          <td class="py-3 px-6 text-left">{{ promotion.pourcentageReduction }}</td>
          <td class="py-3 px-6 text-left">{{ formatDateForInput(promotion.dateDebut) }}</td>
          <td class="py-3 px-6 text-left">{{ formatDateForInput(promotion.dateFin) }}</td>
          <td class="py-3 px-6 text-left">{{ promotion.conditionPromotion || 'N/A' }}</td>
          <td class="py-3 px-6 text-left">{{ promotion.active ? 'Oui' : 'Non' }}</td>
          <td class="py-3 px-6 text-left">
            <div *ngIf="promotion.produits && promotion.produits.length > 0; else noProducts">
              <ul class="list-disc pl-5">
                <li *ngFor="let product of promotion.produits">
                  {{ product.nom }}: 
                  <span class="font-semibold">Prix initial: {{ product.prix }} {{ product.devise || 'TND' }}</span>,
                  <span class="font-semibold text-green-600">Prix réduit: {{ calculateDiscountedPrice(product.prix, promotion.pourcentageReduction) }} {{ product.devise || 'TND' }}</span>
                </li>
              </ul>
            </div>
            <ng-template #noProducts>
              <span class="text-gray-500">Aucun produit associé</span>
            </ng-template>
          </td>
          <td class="py-3 px-6 text-left flex space-x-2">
            <button *ngIf="isAISuggested(promotion)" (click)="acceptAISuggestion(promotion.id)"
                    class="bg-green-500 text-white font-semibold py-1 px-2 rounded-lg hover:bg-green-600 transition-colors">
              Accepter
            </button>
            <button *ngIf="isAISuggested(promotion)" (click)="rejectAISuggestion(promotion.id)"
                    class="bg-red-500 text-white font-semibold py-1 px-2 rounded-lg hover:bg-red-600 transition-colors">
              Rejeter
            </button>
            <button (click)="editPromotion(promotion)"
                    class="bg-yellow-500 text-white font-semibold py-1 px-2 rounded-lg hover:bg-yellow-600 transition-colors">
              Modifier
            </button>
            <button (click)="deletePromotion(promotion.id)"
                    class="bg-red-500 text-white font-semibold py-1 px-2 rounded-lg hover:bg-red-600 transition-colors">
              Supprimer
            </button>
            <button (click)="toggleActiveStatus(promotion)"
                    class="font-semibold py-2 px-3 rounded-lg transition-colors"
                    [ngClass]="promotion.active ? 'bg-green-500 text-white' : 'bg-gray-500 text-white'">
              {{ promotion.active ? 'Désactiver' : 'Activer' }}
            </button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <!-- Pagination -->
<div class="mt-4 flex justify-between items-center">
  <button (click)="previousPage()" 
          class="bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors" 
          [disabled]="currentPage === 1">
    Précédent
  </button>

  <span class="text-gray-700">
    Page {{ currentPage }} sur {{ totalPages }}
  </span>

  <button (click)="nextPage()" 
          class="bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors" 
          [disabled]="currentPage === totalPages">
    Suivant
  </button>
</div>
